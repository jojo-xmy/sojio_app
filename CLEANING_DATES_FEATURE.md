# 清扫日期管理功能

## 功能概述

本功能实现了房东端清扫日期的多选管理，以及管理员端基于房东选择的清扫日期生成独立任务的功能。

## 主要特性

### 1. 房东端功能
- **多选清扫日期**：在入住登记编辑界面可以多选清扫日期
- **日历式选择器**：使用直观的日历界面选择日期
- **标签显示**：已选择的日期以标签形式展示，支持删除
- **自动任务生成**：选择清扫日期后自动生成对应的清扫任务

### 2. 管理员端功能
- **独立任务生成**：每个清扫日期生成一条独立的清扫任务
- **任务日期管理**：管理员可在任务编辑表单中更改任务日期
- **人员管理优化**：
  - "追加人员"按钮改为"更改人员"
  - 支持清扫人员的增加与删除
  - 完全替换模式，而不是追加模式

### 3. 通知系统
- **LINE Bot集成**：为后续LINE bot通知预留接口
- **任务创建通知**：新任务创建时通知管理员
- **任务分配通知**：任务分配给清洁员时发送通知
- **日期变更通知**：清扫日期变更时通知相关人员

## 技术实现

### 数据模型更新
- `calendar_entries`表新增`cleaning_dates`字段（JSONB类型）
- 新增`task_notifications`表用于管理通知

### 核心组件
- `MultiDateSelector`：多选日期组件
- `notificationService`：通知服务
- 更新的`TaskDetailPanel`：支持人员管理

### API接口
- `/api/notifications/send`：手动发送通知
- `/api/cron/notifications`：定时发送通知（每5分钟）

## 使用方法

### 房东端操作
1. 进入酒店日历页面
2. 点击"添加入住登记"或编辑现有登记
3. 在"清扫日期"字段选择多个日期
4. 保存后系统自动生成对应的清扫任务

### 管理员端操作
1. 在任务管理界面查看生成的清扫任务
2. 点击"更改人员"按钮管理清洁员分配
3. 在任务编辑表单中修改清扫日期
4. 系统自动发送相关通知

## 环境变量配置

```env
# LINE Bot配置
LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token
LINE_CHANNEL_SECRET=your_channel_secret

# API安全
NOTIFICATION_API_KEY=your_api_key
CRON_SECRET=your_cron_secret
```

## 数据库迁移

运行以下迁移文件：
```sql
-- 执行 hug_app/supabase/migrations/add_cleaning_dates_and_notifications.sql
```

## 注意事项

1. **数据同步**：清扫日期的变更会自动同步到相关任务
2. **通知延迟**：通知系统使用定时任务，可能有最多5分钟的延迟
3. **权限控制**：确保只有有权限的用户可以修改清扫日期和人员分配
4. **错误处理**：通知发送失败不会影响主要业务流程

## 后续扩展

- 完善LINE Bot消息模板
- 添加更多通知类型
- 实现实时通知推送
- 添加通知历史记录查看功能
